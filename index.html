<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å­¸ç”Ÿè‹±æ–‡æ‹¼å­—å­¸ç¿’æ©Ÿ ğŸ</title>
    <style>
        :root {
            --primary: #FFD54F; /* äº®é»ƒ */
            --primary-dark: #FFC107;
            --secondary: #4FC3F7; /* å¤©ç©ºè— */
            --accent: #FF7043; /* æ´»æ½‘æ©˜ */
            --bg: #FFF9C4; /* æ·¡å¥¶æ²¹è‰²èƒŒæ™¯ */
            --text: #37474F;
            --white: #ffffff;
            --vowel: #E53935; /* æ¯éŸ³ç´… */
            --consonant: #1E88E5; /* å­éŸ³è— */
            --success: #66BB6A;
            --error: #EF5350;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Header Area */
        header {
            width: 100%;
            background: var(--primary);
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 { margin: 0 0 10px 0; font-size: 1.5rem; color: #5D4037; }
        
        .controls-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        select {
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid var(--primary-dark);
            font-size: 1rem;
            background: white;
            outline: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            width: 95%;
            max-width: 600px;
            margin: 20px auto 10px;
            background: rgba(255,255,255,0.6);
            border-radius: 30px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            border-radius: 25px;
            transition: all 0.3s;
            color: #78909C;
        }

        .tab-btn.active {
            background: var(--secondary);
            color: white;
            box-shadow: 0 4px 6px rgba(79, 195, 247, 0.4);
        }

        /* Main Game Area */
        #game-area {
            width: 95%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            text-align: center;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Mode A: Study Styles */
        .big-word {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 20px 0;
            letter-spacing: 2px;
            word-break: break-word;
        }
        .vowel { color: var(--vowel); }
        .consonant { color: var(--consonant); }
        
        .syllable-display {
            font-size: 1.5rem;
            color: #888;
            margin-bottom: 10px;
            height: 30px;
        }

        /* Mode B: Blocks */
        .letter-slots {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            min-height: 60px;
        }
        .slot {
            width: 45px;
            height: 45px;
            border-bottom: 3px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text);
        }
        .slot.filled { border-bottom-color: var(--secondary); }
        
        .scramble-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .block-btn {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--primary-dark);
            transition: transform 0.1s;
        }
        .block-btn:active { transform: translateY(4px); box-shadow: none; }
        .block-btn:disabled { background: #eee; color: #ccc; box-shadow: none; cursor: default; transform: none; }

        /* Mode C: Dictation */
        .input-box {
            font-size: 2rem;
            padding: 10px;
            width: 80%;
            text-align: center;
            border: 3px solid var(--secondary);
            border-radius: 15px;
            outline: none;
            margin: 20px 0;
        }
        .input-box:focus { border-color: var(--accent); }

        /* Common Info */
        .chinese { font-size: 1.5rem; margin-top: 10px; color: #555; }
        .sentence { font-style: italic; color: #888; margin-top: 10px; font-size: 0.9rem; }
        
        /* Navigation */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: auto;
            padding-top: 20px;
        }
        .action-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #D84315;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .speak-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            background: var(--secondary);
            box-shadow: 0 4px 0 #0288D1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feedback {
            font-size: 1.2rem;
            height: 30px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        @keyframes pop {
            0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); }
        }
        .anim-shake { animation: shake 0.4s; color: var(--error); }
        .anim-pop { animation: pop 0.3s; color: var(--success); }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .big-word { font-size: 2.5rem; }
            .slot { width: 35px; height: 35px; font-size: 1.4rem; }
            .block-btn { width: 40px; height: 40px; font-size: 1.2rem; }
            h1 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ Spelling Bee æ‹¼å­—å­¸ç¿’æ©Ÿ</h1>
    <div class="controls-row">
        <select id="levelSelect" onchange="changeLevel()">
            </select>
        <select id="voiceSelect" onchange="setVoice()">
            <option value="">è¼‰å…¥èªéŸ³ä¸­...</option>
        </select>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="switchMode('study')" id="tab-study">ğŸ‘€ èªè­˜å–®å­—</button>
    <button class="tab-btn" onclick="switchMode('block')" id="tab-block">ğŸ§© æ‹¼æ‹¼åœ–</button>
    <button class="tab-btn" onclick="switchMode('dictation')" id="tab-dictation">âœï¸ è½å¯«æ¸¬é©—</button>
</div>

<div id="game-area">
    </div>

<script>
    // ==========================================
    // 1. è³‡æ–™è™•ç†èˆ‡åˆå§‹åŒ–
    // ==========================================
    
    // åŸå§‹å–®å­—å­—ä¸²
    const rawWords = "absolute.actual.adopt.amiss.anew.applesauce.astray.awful.bloodhound.capture.carefree.clump.cobweb.concern.conduct.course.crystal.egret.farther.fiber.fortune.fountain.gentle.glory.godfather.greenhouse.handsome.hollow.honest.joined.kingdom.liberty.limit.location.loose.magnet.meaning.metal.midnight.mink.mistreat.misuse.moral.motion.murder.noble.observe.occur.odor.oneself.operate.oriole.otherwise.pause.perfume.pollute.powder.prefer.prevent.private.proper.provide.recent.reduce.regular.royal.rumble.sailor.scatter.scent.seize.servant.shoplift.silkworm.skyrocket.snowstorm.sputter.steady.straight.sturdy.style.surface.sweat.tangle.task.tease.temple.thief.thigh.tour.twice.union.usual.vapor.volume.wander.wealth.whenever.wound.zigzag";

    // ç°¡å–®çš„ä¸­æ–‡æ˜ å°„èˆ‡éŸ³ç¯€ç”¢ç”Ÿé‚è¼¯ (æ¨¡æ“¬è³‡æ–™åº«)
    // ç‚ºäº†æª”æ¡ˆè¼•é‡åŒ–ï¼Œæˆ‘å€‘ç”¨ç°¡å–®é‚è¼¯ç”¢ç”Ÿï¼Œéƒ¨åˆ†ä¸­æ–‡ç‚ºé€šç”¨ç¿»è­¯
    const dictionary = {
        absolute: { zh: "çµ•å°çš„", syl: ["ab", "so", "lute"] },
        actual: { zh: "å¯¦éš›çš„", syl: ["ac", "tu", "al"] },
        adopt: { zh: "æ”¶é¤Šï¼›æ¡ç”¨", syl: ["a", "dopt"] },
        amiss: { zh: "æœ‰æ¯›ç—…çš„", syl: ["a", "miss"] },
        anew: { zh: "é‡æ–°", syl: ["a", "new"] },
        applesauce: { zh: "è˜‹æœé†¬", syl: ["ap", "ple", "sauce"] },
        astray: { zh: "è¿·è·¯çš„", syl: ["a", "stray"] },
        awful: { zh: "ç³Ÿç³•çš„", syl: ["aw", "ful"] },
        bloodhound: { zh: "è­¦çŠ¬", syl: ["blood", "hound"] },
        capture: { zh: "æ•æ‰", syl: ["cap", "ture"] },
        carefree: { zh: "ç„¡æ†‚ç„¡æ…®çš„", syl: ["care", "free"] },
        clump: { zh: "æ¨¹å¢ï¼›ä¸€åœ˜", syl: ["clump"] },
        cobweb: { zh: "èœ˜è››ç¶²", syl: ["cob", "web"] },
        concern: { zh: "é—œå¿ƒ", syl: ["con", "cern"] },
        conduct: { zh: "è¡Œç‚ºï¼›å¼•å°", syl: ["con", "duct"] },
        course: { zh: "èª²ç¨‹ï¼›è·¯ç·š", syl: ["course"] },
        crystal: { zh: "æ°´æ™¶", syl: ["crys", "tal"] },
        egret: { zh: "ç™½é·º", syl: ["e", "gret"] },
        farther: { zh: "æ›´é çš„", syl: ["far", "ther"] },
        fiber: { zh: "çº–ç¶­", syl: ["fi", "ber"] },
        fortune: { zh: "è²¡å¯Œï¼›é‹æ°£", syl: ["for", "tune"] },
        fountain: { zh: "å™´æ³‰", syl: ["foun", "tain"] },
        gentle: { zh: "æº«æŸ”çš„", syl: ["gen", "tle"] },
        glory: { zh: "å…‰æ¦®", syl: ["glo", "ry"] },
        godfather: { zh: "æ•™çˆ¶", syl: ["god", "fa", "ther"] },
        greenhouse: { zh: "æº«å®¤", syl: ["green", "house"] },
        handsome: { zh: "è‹±ä¿Šçš„", syl: ["hand", "some"] },
        hollow: { zh: "ä¸­ç©ºçš„", syl: ["hol", "low"] },
        honest: { zh: "èª å¯¦çš„", syl: ["hon", "est"] },
        joined: { zh: "é€£çµçš„", syl: ["joined"] },
        kingdom: { zh: "ç‹åœ‹", syl: ["king", "dom"] },
        liberty: { zh: "è‡ªç”±", syl: ["lib", "er", "ty"] },
        limit: { zh: "é™åˆ¶", syl: ["lim", "it"] },
        location: { zh: "åœ°é»", syl: ["lo", "ca", "tion"] },
        loose: { zh: "é¬†çš„", syl: ["loose"] },
        magnet: { zh: "ç£éµ", syl: ["mag", "net"] },
        meaning: { zh: "æ„ç¾©", syl: ["mean", "ing"] },
        metal: { zh: "é‡‘å±¬", syl: ["met", "al"] },
        midnight: { zh: "åˆå¤œ", syl: ["mid", "night"] },
        mink: { zh: "è²‚çš®", syl: ["mink"] },
        mistreat: { zh: "è™å¾…", syl: ["mis", "treat"] },
        misuse: { zh: "èª¤ç”¨", syl: ["mis", "use"] },
        moral: { zh: "é“å¾·çš„", syl: ["mor", "al"] },
        motion: { zh: "å‹•ä½œ", syl: ["mo", "tion"] },
        murder: { zh: "è¬€æ®º", syl: ["mur", "der"] },
        noble: { zh: "é«˜å°šçš„", syl: ["no", "ble"] },
        observe: { zh: "è§€å¯Ÿ", syl: ["ob", "serve"] },
        occur: { zh: "ç™¼ç”Ÿ", syl: ["oc", "cur"] },
        odor: { zh: "æ°£å‘³", syl: ["o", "dor"] },
        oneself: { zh: "è‡ªå·±", syl: ["one", "self"] },
        operate: { zh: "æ“ä½œ", syl: ["op", "er", "ate"] },
        oriole: { zh: "é»ƒé¸é³¥", syl: ["o", "ri", "ole"] },
        otherwise: { zh: "å¦å‰‡", syl: ["oth", "er", "wise"] },
        pause: { zh: "æš«åœ", syl: ["pause"] },
        perfume: { zh: "é¦™æ°´", syl: ["per", "fume"] },
        pollute: { zh: "æ±¡æŸ“", syl: ["pol", "lute"] },
        powder: { zh: "ç²‰æœ«", syl: ["pow", "der"] },
        prefer: { zh: "åå¥½", syl: ["pre", "fer"] },
        prevent: { zh: "é é˜²", syl: ["pre", "vent"] },
        private: { zh: "ç§äººçš„", syl: ["pri", "vate"] },
        proper: { zh: "é©ç•¶çš„", syl: ["prop", "er"] },
        provide: { zh: "æä¾›", syl: ["pro", "vide"] },
        recent: { zh: "æœ€è¿‘çš„", syl: ["re", "cent"] },
        reduce: { zh: "æ¸›å°‘", syl: ["re", "duce"] },
        regular: { zh: "è¦å¾‹çš„", syl: ["reg", "u", "lar"] },
        royal: { zh: "çš‡å®¶çš„", syl: ["roy", "al"] },
        rumble: { zh: "éš†éš†è²", syl: ["rum", "ble"] },
        sailor: { zh: "æ°´æ‰‹", syl: ["sail", "or"] },
        scatter: { zh: "æ•£æ’­", syl: ["scat", "ter"] },
        scent: { zh: "æ°£å‘³", syl: ["scent"] },
        seize: { zh: "æŠ“ä½", syl: ["seize"] },
        servant: { zh: "åƒ•äºº", syl: ["ser", "vant"] },
        shoplift: { zh: "é †æ‰‹ç‰½ç¾Š", syl: ["shop", "lift"] },
        silkworm: { zh: "è ¶", syl: ["silk", "worm"] },
        skyrocket: { zh: "é£›æ¼²", syl: ["sky", "rock", "et"] },
        snowstorm: { zh: "æš´é¢¨é›ª", syl: ["snow", "storm"] },
        sputter: { zh: "å™´æ¿ºè²", syl: ["sput", "ter"] },
        steady: { zh: "ç©©å®šçš„", syl: ["stead", "y"] },
        straight: { zh: "ç›´çš„", syl: ["straight"] },
        sturdy: { zh: "å …å›ºçš„", syl: ["stur", "dy"] },
        style: { zh: "é¢¨æ ¼", syl: ["style"] },
        surface: { zh: "è¡¨é¢", syl: ["sur", "face"] },
        sweat: { zh: "æ±—æ°´", syl: ["sweat"] },
        tangle: { zh: "ç³¾çµ", syl: ["tan", "gle"] },
        task: { zh: "ä»»å‹™", syl: ["task"] },
        tease: { zh: "æˆ²å¼„", syl: ["tease"] },
        temple: { zh: "å¯ºå»Ÿ", syl: ["tem", "ple"] },
        thief: { zh: "å°å·", syl: ["thief"] },
        thigh: { zh: "å¤§è…¿", syl: ["thigh"] },
        tour: { zh: "æ—…éŠ", syl: ["tour"] },
        twice: { zh: "å…©æ¬¡", syl: ["twice"] },
        union: { zh: "è¯åˆ", syl: ["un", "ion"] },
        usual: { zh: "é€šå¸¸çš„", syl: ["u", "su", "al"] },
        vapor: { zh: "è’¸æ°£", syl: ["va", "por"] },
        volume: { zh: "é«”ç©ï¼›éŸ³é‡", syl: ["vol", "ume"] },
        wander: { zh: "æ¼«éŠ", syl: ["wan", "der"] },
        wealth: { zh: "è²¡å¯Œ", syl: ["wealth"] },
        whenever: { zh: "ç„¡è«–ä½•æ™‚", syl: ["when", "ev", "er"] },
        wound: { zh: "å‚·å£", syl: ["wound"] },
        zigzag: { zh: "Zå­—å½¢", syl: ["zig", "zag"] }
    };

    // å»ºç«‹è³‡æ–™é™£åˆ—
    let allWords = [];
    const list = rawWords.split('.').filter(w => w.length > 0);
    
    list.forEach(w => {
        const info = dictionary[w] || { zh: "å–®å­—", syl: [w] };
        allWords.push({
            word: w,
            syllables: info.syl,
            meaning: info.zh,
            sentence: `The word is ${w}.` // ç°¡å–®ä¾‹å¥
        });
    });

    // è®Šæ•¸è¨­å®š
    let currentLevelWords = [];
    let currentIndex = 0;
    let currentMode = 'study';
    let currentVoice = null;
    let isSyllableShown = false;
    let synth = window.speechSynthesis;

    // ==========================================
    // 2. ç¨‹å¼å•Ÿå‹•é‚è¼¯
    // ==========================================

    window.onload = function() {
        initLevels();
        initVoices();
        loadLevel(0);
    };

    function initLevels() {
        const select = document.getElementById('levelSelect');
        const totalLevels = Math.ceil(allWords.length / 10);
        
        for(let i=0; i<totalLevels; i++) {
            let option = document.createElement('option');
            option.value = i;
            option.text = `Level ${i+1} (${i*10+1}-${Math.min((i+1)*10, allWords.length)})`;
            select.appendChild(option);
        }
        let allOpt = document.createElement('option');
        allOpt.value = 'all';
        allOpt.text = 'å…¨éƒ¨å–®å­—æŒ‘æˆ°';
        select.appendChild(allOpt);
    }

    // èªéŸ³è¼‰å…¥è™•ç†ï¼ˆè™•ç†ä¸åŒç€è¦½å™¨å·®ç•°ï¼‰
    function initVoices() {
        const voiceSelect = document.getElementById('voiceSelect');
        
        function load() {
            let voices = synth.getVoices();
            if(voices.length === 0) return;
            
            voiceSelect.innerHTML = '';
            // å„ªå…ˆå°‹æ‰¾ Google US English æˆ–å…¶ä»–è‹±æ–‡
            let selectedIndex = 0;
            
            voices.forEach((voice, index) => {
                let option = document.createElement('option');
                option.value = index;
                option.text = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
                
                if (voice.lang === 'en-US' && voice.name.includes('Google')) {
                    selectedIndex = index;
                } else if (!currentVoice && voice.lang.includes('en')) {
                    selectedIndex = index;
                }
            });
            
            voiceSelect.selectedIndex = selectedIndex;
            currentVoice = voices[selectedIndex];
        }

        load();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = load;
        }
    }

    function setVoice() {
        const voiceSelect = document.getElementById('voiceSelect');
        const voices = synth.getVoices();
        currentVoice = voices[voiceSelect.value];
    }

    function changeLevel() {
        const select = document.getElementById('levelSelect');
        loadLevel(select.value);
    }

    function loadLevel(val) {
        if(val === 'all') {
            currentLevelWords = [...allWords];
        } else {
            let start = parseInt(val) * 10;
            let end = start + 10;
            currentLevelWords = allWords.slice(start, end);
        }
        currentIndex = 0;
        renderGame();
    }

    function switchMode(mode) {
        currentMode = mode;
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        isSyllableShown = false; // é‡ç½®éŸ³ç¯€é¡¯ç¤º
        renderGame();
    }

    // ==========================================
    // 3. æ¸²æŸ“èˆ‡éŠæˆ²é‚è¼¯
    // ==========================================

    function renderGame() {
        const container = document.getElementById('game-area');
        const wordObj = currentLevelWords[currentIndex];
        
        if(!wordObj) return;

        let html = '';
        
        // é ‚éƒ¨é€²åº¦
        html += `<div style="color: #999; margin-bottom: 10px;">Word ${currentIndex + 1} / ${currentLevelWords.length}</div>`;

        // æ ¹æ“šæ¨¡å¼æ¸²æŸ“å…§å®¹
        if (currentMode === 'study') {
            // --- æ¨¡å¼ A: å­¸ç¿’ ---
            html += `<div class="feedback" id="feedback-msg"></div>`;
            html += `<div class="syllable-display" id="syl-display">${isSyllableShown ? wordObj.syllables.join(' â€¢ ') : ''}</div>`;
            html += `<div class="big-word">${colorCodeWord(wordObj.word)}</div>`;
            html += `<div class="chinese">${wordObj.meaning}</div>`;
            html += `<div class="sentence">"${wordObj.sentence}"</div>`;
            
            html += `
            <div class="nav-controls">
                 <button class="action-btn" onclick="toggleSyllable()">é¡¯ç¤ºéŸ³ç¯€</button>
                 <button class="action-btn speak-btn" onclick="speakWord()">ğŸ”Š</button>
                 <button class="action-btn" onclick="nextWord()">ä¸‹ä¸€å­— â¡</button>
            </div>`;
            
        } else if (currentMode === 'block') {
            // --- æ¨¡å¼ B: ç©æœ¨ ---
            html += `<div class="feedback" id="feedback-msg">é‡çµ„å–®å­—ï¼</div>`;
            html += `<div class="chinese">${wordObj.meaning}</div>`;
            
            // ç­”æ¡ˆå€
            html += `<div class="letter-slots" id="slots-area">`;
            for(let i=0; i<wordObj.word.length; i++) {
                html += `<div class="slot" id="slot-${i}"></div>`;
            }
            html += `</div>`;
            
            // æŒ‰éˆ•å€
            html += `<div class="scramble-area" id="block-btns"></div>`;
            
            html += `
            <div class="nav-controls">
                 <button class="action-btn" style="background:#ccc" onclick="resetBlockGame()">é‡ç½®</button>
                 <button class="action-btn speak-btn" onclick="speakWord()">ğŸ”Š</button>
                 <button class="action-btn" onclick="nextWord()">è·³é â¡</button>
            </div>`;
            
            // æ¸²æŸ“å¾Œåˆå§‹åŒ–ç©æœ¨æŒ‰éˆ•
            setTimeout(() => initBlockGame(wordObj.word), 0);

        } else if (currentMode === 'dictation') {
            // --- æ¨¡å¼ C: è½å¯« ---
            html += `<div class="feedback" id="feedback-msg">è½éŸ³è¼¸å…¥</div>`;
            html += `<div class="chinese">${wordObj.meaning}</div>`;
            html += `<input type="text" class="input-box" id="dict-input" autocomplete="off" placeholder="Type here...">`;
            
            html += `
            <div class="nav-controls">
                 <button class="action-btn" onclick="checkDictation()">æª¢æŸ¥ âœ…</button>
                 <button class="action-btn speak-btn" onclick="speakWord()">ğŸ”Š</button>
                 <button class="action-btn" onclick="nextWord()">è·³é â¡</button>
            </div>`;
        }

        container.innerHTML = html;

        // åˆ‡æ›å–®å­—è‡ªå‹•ç™¼éŸ³
        if(currentMode !== 'study') {
            setTimeout(speakWord, 500);
        }
    }

    // --- è¼”åŠ©åŠŸèƒ½ ---

    function nextWord() {
        if (currentIndex < currentLevelWords.length - 1) {
            currentIndex++;
            isSyllableShown = false;
            renderGame();
        } else {
            alert("æ­å–œï¼é€™å€‹ Level å®Œæˆäº†ï¼ğŸ‰");
            currentIndex = 0;
            renderGame();
        }
    }

    function speakWord() {
        if(!currentVoice) {
            initVoices(); // å˜—è©¦é‡æ–°è¼‰å…¥
        }
        const word = currentLevelWords[currentIndex].word;
        const utterance = new SpeechSynthesisUtterance(word);
        if(currentVoice) utterance.voice = currentVoice;
        utterance.rate = 0.8; // ç¨å¾®æ”¾æ…¢çµ¦å°å­©è½
        synth.speak(utterance);
    }

    // æ¨¡å¼ A: å­—ä¸²æŸ“è‰²
    function colorCodeWord(word) {
        return word.split('').map(char => {
            if (/[aeiou]/i.test(char)) return `<span class="vowel">${char}</span>`;
            return `<span class="consonant">${char}</span>`;
        }).join('');
    }

    function toggleSyllable() {
        isSyllableShown = !isSyllableShown;
        const display = document.getElementById('syl-display');
        const wordObj = currentLevelWords[currentIndex];
        display.innerText = isSyllableShown ? wordObj.syllables.join(' â€¢ ') : '';
    }

    // æ¨¡å¼ B: ç©æœ¨é‚è¼¯
    let currentBlockAnswer = "";
    
    function initBlockGame(word) {
        currentBlockAnswer = "";
        const chars = word.split('').map((c, i) => ({char: c, id: i}));
        // æ´—ç‰Œç®—æ³•
        for (let i = chars.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [chars[i], chars[j]] = [chars[j], chars[i]];
        }
        
        const btnContainer = document.getElementById('block-btns');
        chars.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'block-btn';
            btn.innerText = item.char;
            btn.onclick = () => onBlockClick(item.char, btn);
            btnContainer.appendChild(btn);
        });
    }

    function onBlockClick(char, btnElement) {
        const targetWord = currentLevelWords[currentIndex].word;
        const nextIndex = currentBlockAnswer.length;
        
        // å°‡å­—æ¯å¡«å…¥æ ¼å­
        const slot = document.getElementById(`slot-${nextIndex}`);
        slot.innerText = char;
        slot.classList.add('filled');
        
        // ç¦ç”¨æŒ‰éˆ•
        btnElement.style.visibility = 'hidden'; // éš±è—ä½†ä½”ä½
        
        currentBlockAnswer += char;

        // æª¢æŸ¥ç•¶å‰é€™ä¸€æ­¥æ˜¯å¦æ­£ç¢º (å¯é¸: å³æ™‚åé¥‹)
        // é€™è£¡åšæœ€å¾Œæª¢æŸ¥
        if (currentBlockAnswer.length === targetWord.length) {
            if (currentBlockAnswer === targetWord) {
                document.getElementById('feedback-msg').innerHTML = "<span class='anim-pop'>Correct! ğŸ‰</span>";
                playSound(true);
                setTimeout(nextWord, 1500);
            } else {
                document.getElementById('feedback-msg').innerHTML = "<span class='anim-shake'>Try Again! âŒ</span>";
                playSound(false);
                setTimeout(resetBlockGame, 1000);
            }
        }
    }

    function resetBlockGame() {
        renderGame();
    }

    // æ¨¡å¼ C: è½å¯«é‚è¼¯
    function checkDictation() {
        const input = document.getElementById('dict-input');
        const target = currentLevelWords[currentIndex].word;
        const msg = document.getElementById('feedback-msg');
        
        if (input.value.trim().toLowerCase() === target.toLowerCase()) {
            msg.innerHTML = "<span class='anim-pop'>Awesome! ğŸŒŸ</span>";
            input.style.borderColor = "var(--success)";
            playSound(true);
            setTimeout(nextWord, 1500);
        } else {
            msg.innerHTML = "<span class='anim-shake'>Oops! ğŸ˜…</span>";
            input.style.borderColor = "var(--error)";
            input.classList.add('anim-shake');
            playSound(false);
            setTimeout(() => {
                input.classList.remove('anim-shake');
                input.value = '';
                input.focus();
            }, 1000);
        }
    }

    // ç°¡å–®éŸ³æ•ˆ (ä½¿ç”¨ Web Audio API ç”Ÿæˆå—¶å—¶è²ï¼Œä¸ä¾è³´å¤–éƒ¨æª”)
    function playSound(isCorrect) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        if (isCorrect) {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(587.33, ctx.currentTime); // D5
            osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1); // A5
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }
    }

</script>
</body>
</html>
